
<<<<<<< Updated upstream:Comment Codes/Statistic_screen_code
class StatisticsScreens extends StatefulWidget {
=======
import 'package:flutter/material.dart';
import 'package:fl_chart/fl_chart.dart';

import '../models/models.dart';
import '../functions/category_managment.dart';
import '../models/storage.dart';
import '../models/themes.dart';

class StatisticsScreen extends StatefulWidget {
>>>>>>> Stashed changes:lib/screens/statistics_screen.dart
  final List<Transaction> transactions;

  const StatisticsScreens({
    super.key,
    required this.transactions,
  });

  @override
  _StatisticsScreensState createState() => _StatisticsScreensState();
}

class _StatisticsScreensState extends State<StatisticsScreens> with TickerProviderStateMixin {
  late TabController _tabController;
  String _selectedPeriod = 'This Month';

  final List<String> _periods = [
    'This Week',
    'This Month',
    'Last 3 Months',
    'This Year',
    'All Time'
  ];

  @override
  void initState() {
    super.initState();
    _tabController = TabController(length: 3, vsync: this);
  }

  @override
  void dispose() {
    _tabController.dispose();
    super.dispose();
  }

  // Helper method to check if transaction is income
  bool _isIncomeTransaction(Transaction transaction) {
    return transaction.type == TransactionType.income;
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: ThemeProvider.getBackgroundColor(),
      appBar: AppBar(
        backgroundColor: ThemeProvider.getBackgroundColor(),
        elevation: 0,
        title: Text(
          'Statistics',
          style: TextStyle(
            color: ThemeProvider.getTextColor(),
            fontWeight: FontWeight.w600,
            fontSize: 24,
          ),
        ),
        actions: [
          PopupMenuButton<String>(
            icon: Icon(Icons.date_range, color: ThemeProvider.getTextColor()),
            onSelected: (value) => setState(() => _selectedPeriod = value),
            itemBuilder: (context) => _periods.map((period) {
              return PopupMenuItem<String>(
                value: period,
                child: Row(
                  children: [
                    Icon(
                      _selectedPeriod == period ? Icons.check : Icons.calendar_today,
                      color: _selectedPeriod == period ? ThemeProvider.getPrimaryColor() : Colors.grey,
                      size: 20,
                    ),
                    SizedBox(width: 12),
                    Text(
                      period,
                      style: TextStyle(
                        color: _selectedPeriod == period ? ThemeProvider.getPrimaryColor() : ThemeProvider.getTextColor(),
                        fontWeight: _selectedPeriod == period ? FontWeight.w600 : FontWeight.normal,
                      ),
                    ),
                  ],
                ),
              );
            }).toList(),
          ),
        ],
      ),
      body: Column(
        children: [
          // Summary Cards
          _buildSummaryCards(),

          // Tab Bar
          Container(
            margin: EdgeInsets.symmetric(horizontal: 20, vertical: 10),
            decoration: BoxDecoration(
              color: ThemeProvider.getCardColor(),
              borderRadius: BorderRadius.circular(16),
            ),
            child: TabBar(
              controller: _tabController,
              labelColor: Colors.white,
              unselectedLabelColor: Colors.grey[400],
              indicator: BoxDecoration(
                color: ThemeProvider.getPrimaryColor(),
                borderRadius: BorderRadius.circular(12),
              ),
              indicatorSize: TabBarIndicatorSize.tab,
              dividerColor: Colors.transparent,
              tabs: [
                Tab(
                  icon: Icon(Icons.pie_chart, size: 20),
                  text: 'Overview',
                ),
                Tab(
                  icon: Icon(Icons.trending_up, size: 20),
                  text: 'Income',
                ),
                Tab(
                  icon: Icon(Icons.trending_down, size: 20),
                  text: 'Expenses',
                ),
              ],
            ),
          ),

          // Tab Content
          Expanded(
            child: TabBarView(
              controller: _tabController,
              children: [
                _buildOverviewTab(),
                _buildIncomeTab(),
                _buildExpenseTab(),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildSummaryCards() {
    final filteredTransactions = _getFilteredTransactions();
    final totalIncome = _calculateTotalIncome(filteredTransactions);
    final totalExpense = _calculateTotalExpense(filteredTransactions);
    final balance = totalIncome - totalExpense;

    return Container(
      padding: EdgeInsets.all(20),
      child: Row(
        children: [
          Expanded(
            child: _buildSummaryCard(
              'Total Income',
              totalIncome,
              Colors.green,
              Icons.trending_up,
            ),
          ),
          SizedBox(width: 12),
          Expanded(
            child: _buildSummaryCard(
              'Total Expense',
              totalExpense,
              Colors.red,
              Icons.trending_down,
            ),
          ),
          SizedBox(width: 12),
          Expanded(
            child: _buildSummaryCard(
              'Balance',
              balance,
              balance >= 0 ? Colors.blue : Colors.orange,
              balance >= 0 ? Icons.account_balance_wallet : Icons.warning,
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildSummaryCard(String title, double amount, Color color, IconData icon) {
    return Container(
      padding: EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: ThemeProvider.getCardColor(),
        borderRadius: BorderRadius.circular(16),
        border: Border.all(color: color.withOpacity(0.2)),
      ),
      child: Column(
        children: [
          Container(
            padding: EdgeInsets.all(8),
            decoration: BoxDecoration(
              color: color.withOpacity(0.1),
              borderRadius: BorderRadius.circular(8),
            ),
            child: Icon(icon, color: color, size: 24),
          ),
          SizedBox(height: 12),
          Text(
            title,
            style: TextStyle(
              color: Colors.grey[400],
              fontSize: 12,
              fontWeight: FontWeight.w500,
            ),
            textAlign: TextAlign.center,
          ),
          SizedBox(height: 4),
          Text(
            '\$${amount.toStringAsFixed(2)}',
            style: TextStyle(
              color: ThemeProvider.getTextColor(),
              fontSize: 16,
              fontWeight: FontWeight.bold,
            ),
            textAlign: TextAlign.center,
          ),
        ],
      ),
    );
  }

  Widget _buildOverviewTab() {
    return SingleChildScrollView(
      padding: EdgeInsets.all(20),
      child: Column(
        children: [
          // Balance Trend Chart
          _buildBalanceTrendChart(),
          SizedBox(height: 24),

          // Income vs Expense Pie Chart
          _buildIncomeExpensePieChart(),
          SizedBox(height: 24),

          // Recent Transactions Summary - FIXED
          _buildRecentTransactionsSummary(),
        ],
      ),
    );
  }

  Widget _buildIncomeTab() {
    return SingleChildScrollView(
      padding: EdgeInsets.all(20),
      child: Column(
        children: [
          // Income Categories Pie Chart
          _buildIncomeCategoriesChart(),
          SizedBox(height: 24),

          // Income Categories List
          _buildIncomeCategoriesList(),
        ],
      ),
    );
  }

  Widget _buildExpenseTab() {
    return SingleChildScrollView(
      padding: EdgeInsets.all(20),
      child: Column(
        children: [
          // Expense Categories Pie Chart
          _buildExpenseCategoriesChart(),
          SizedBox(height: 24),

          // Expense Categories List
          _buildExpenseCategoriesList(),
        ],
      ),
    );
  }

  Widget _buildBalanceTrendChart() {
    final balanceTrendData = _generateRealBalanceTrendData();

    if (balanceTrendData.isEmpty) {
      return Container(
        padding: EdgeInsets.all(20),
        decoration: BoxDecoration(
          color: ThemeProvider.getCardColor(),
          borderRadius: BorderRadius.circular(16),
        ),
        child: Column(
          children: [
            Icon(Icons.show_chart, size: 64, color: Colors.grey[400]),
            SizedBox(height: 16),
            Text(
              'No transaction data available for trend analysis',
              style: TextStyle(
                color: Colors.grey[400],
                fontSize: 16,
              ),
              textAlign: TextAlign.center,
            ),
          ],
        ),
      );
    }

    final minY = balanceTrendData.map((spot) => spot.y).reduce((a, b) => a < b ? a : b);
    final maxY = balanceTrendData.map((spot) => spot.y).reduce((a, b) => a > b ? a : b);
    final range = maxY - minY;
    final padding = range * 0.1; // 10% padding

    return Container(
      padding: EdgeInsets.all(20),
      decoration: BoxDecoration(
        color: ThemeProvider.getCardColor(),
        borderRadius: BorderRadius.circular(16),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            children: [
              Icon(Icons.show_chart, color: ThemeProvider.getPrimaryColor(), size: 24),
              SizedBox(width: 12),
              Text(
                'Balance Trend',
                style: TextStyle(
                  color: ThemeProvider.getTextColor(),
                  fontSize: 20,
                  fontWeight: FontWeight.bold,
                ),
              ),
            ],
          ),
          SizedBox(height: 20),
          SizedBox(
            height: 200,
            child: LineChart(
              LineChartData(
                gridData: FlGridData(
                  show: true,
                  drawVerticalLine: true,
                  drawHorizontalLine: true,
                  horizontalInterval: range > 0 ? range / 4 : 1000,
                  verticalInterval: balanceTrendData.length > 1 ? (balanceTrendData.length - 1).toDouble() / 4 : 1,
                  getDrawingHorizontalLine: (value) {
                    return FlLine(
                      color: Colors.grey.withOpacity(0.2),
                      strokeWidth: 1,
                    );
                  },
                  getDrawingVerticalLine: (value) {
                    return FlLine(
                      color: Colors.grey.withOpacity(0.2),
                      strokeWidth: 1,
                    );
                  },
                ),
                titlesData: FlTitlesData(
                  show: true,
                  rightTitles: AxisTitles(sideTitles: SideTitles(showTitles: false)),
                  topTitles: AxisTitles(sideTitles: SideTitles(showTitles: false)),
                  bottomTitles: AxisTitles(
                    sideTitles: SideTitles(
                      showTitles: true,
                      reservedSize: 30,
                      interval: balanceTrendData.length > 1 ? (balanceTrendData.length - 1).toDouble() / 4 : 1,
                      getTitlesWidget: (double value, TitleMeta meta) {
                        if (value.toInt() >= 0 && value.toInt() < balanceTrendData.length) {
                          final date = _getDateForIndex(value.toInt());
                          return SideTitleWidget(
                            axisSide: meta.axisSide,
                            child: Text(
                              '${date.month}/${date.day}',
                              style: TextStyle(
                                color: Colors.grey[400],
                                fontSize: 12,
                              ),
                            ),
                          );
                        }
                        return Container();
                      },
                    ),
                  ),
                  leftTitles: AxisTitles(
                    sideTitles: SideTitles(
                      showTitles: true,
                      interval: range > 0 ? range / 4 : 1000,
                      reservedSize: 60,
                      getTitlesWidget: (double value, TitleMeta meta) {
                        return SideTitleWidget(
                          axisSide: meta.axisSide,
                          child: Text(
                            '\$${value.toInt()}',
                            style: TextStyle(
                              color: Colors.grey[400],
                              fontSize: 12,
                            ),
                          ),
                        );
                      },
                    ),
                  ),
                ),
                borderData: FlBorderData(
                  show: true,
                  border: Border.all(
                    color: Colors.grey.withOpacity(0.2),
                    width: 1,
                  ),
                ),
                minX: 0,
                maxX: (balanceTrendData.length - 1).toDouble(),
                minY: minY - padding,
                maxY: maxY + padding,
                lineBarsData: [
                  LineChartBarData(
                    spots: balanceTrendData,
                    isCurved: true,
                    color: ThemeProvider.getPrimaryColor(),
                    barWidth: 3,
                    isStrokeCapRound: true,
                    dotData: FlDotData(
                      show: true,
                      getDotPainter: (spot, percent, barData, index) {
                        return FlDotCirclePainter(
                          radius: 4,
                          color: ThemeProvider.getPrimaryColor(),
                          strokeWidth: 2,
                          strokeColor: Colors.white,
                        );
                      },
                    ),
                    belowBarData: BarAreaData(
                      show: true,
                      color: ThemeProvider.getPrimaryColor().withOpacity(0.1),
                    ),
                  ),
                ],
                lineTouchData: LineTouchData(
                  enabled: true,
                  touchTooltipData: LineTouchTooltipData(
                    tooltipRoundedRadius: 8,
                    getTooltipItems: (List<LineBarSpot> touchedBarSpots) {
                      return touchedBarSpots.map((barSpot) {
                        final date = _getDateForIndex(barSpot.x.toInt());
                        return LineTooltipItem(
                          '${date.month}/${date.day}\n\$${barSpot.y.toStringAsFixed(2)}',
                          TextStyle(
                            color: ThemeProvider.getTextColor(),
                            fontWeight: FontWeight.bold,
                          ),
                        );
                      }).toList();
                    },
                  ),
                ),
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildIncomeExpensePieChart() {
    final filteredTransactions = _getFilteredTransactions();
    final totalIncome = _calculateTotalIncome(filteredTransactions);
    final totalExpense = _calculateTotalExpense(filteredTransactions);

    if (totalIncome == 0 && totalExpense == 0) {
      return Container(
        padding: EdgeInsets.all(20),
        decoration: BoxDecoration(
          color: ThemeProvider.getCardColor(),
          borderRadius: BorderRadius.circular(16),
        ),
        child: Column(
          children: [
            Icon(Icons.pie_chart_outline, size: 64, color: Colors.grey[400]),
            SizedBox(height: 16),
            Text(
              'No data available for selected period',
              style: TextStyle(
                color: Colors.grey[400],
                fontSize: 16,
              ),
            ),
          ],
        ),
      );
    }

    final total = totalIncome + totalExpense;
    final incomePercentage = total > 0 ? (totalIncome / total) * 100 : 0.0;
    final expensePercentage = total > 0 ? (totalExpense / total) * 100 : 0.0;

    return Container(
      padding: EdgeInsets.all(20),
      decoration: BoxDecoration(
        color: ThemeProvider.getCardColor(),
        borderRadius: BorderRadius.circular(16),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            children: [
              Icon(Icons.pie_chart, color: Colors.purple, size: 24),
              SizedBox(width: 12),
              Text(
                'Income vs Expenses',
                style: TextStyle(
                  color: ThemeProvider.getTextColor(),
                  fontSize: 20,
                  fontWeight: FontWeight.bold,
                ),
              ),
            ],
          ),
          SizedBox(height: 20),
          Row(
            children: [
              Expanded(
                child: SizedBox(
                  height: 200,
                  child: PieChart(
                    PieChartData(
                      sections: [
                        if (totalIncome > 0)
                          PieChartSectionData(
                            value: totalIncome,
                            color: Colors.green,
                            title: '${incomePercentage.toStringAsFixed(1)}%',
                            radius: 80,
                            titleStyle: TextStyle(
                              color: Colors.white,
                              fontWeight: FontWeight.bold,
                              fontSize: 14,
                            ),
                          ),
                        if (totalExpense > 0)
                          PieChartSectionData(
                            value: totalExpense,
                            color: Colors.red,
                            title: '${expensePercentage.toStringAsFixed(1)}%',
                            radius: 80,
                            titleStyle: TextStyle(
                              color: Colors.white,
                              fontWeight: FontWeight.bold,
                              fontSize: 14,
                            ),
                          ),
                      ],
                      sectionsSpace: 2,
                      centerSpaceRadius: 40,
                      pieTouchData: PieTouchData(
                        enabled: true,
                        touchCallback: (FlTouchEvent event, pieTouchResponse) {
                          // Handle touch events if needed
                        },
                      ),
                    ),
                  ),
                ),
              ),
              // SizedBox(width: 20),
            ],
          ),
          const SizedBox(height: 20),
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              if (totalIncome > 0) _buildLegendItem('Income', Colors.green, totalIncome),
              if (totalIncome > 0 && totalExpense > 0) SizedBox(height: 12),
              if (totalExpense > 0) _buildLegendItem('Expenses', Colors.red, totalExpense),
            ],
          ),
        ],
      ),
    );
  }

  Widget _buildIncomeCategoriesChart() {
    final incomeByCategory = _getIncomeByCategory();

    if (incomeByCategory.isEmpty) {
      return Container(
        padding: EdgeInsets.all(20),
        decoration: BoxDecoration(
          color: ThemeProvider.getCardColor(),
          borderRadius: BorderRadius.circular(16),
        ),
        child: Column(
          children: [
            Icon(Icons.category_outlined, size: 64, color: Colors.grey[400]),
            SizedBox(height: 16),
            Text(
              'No income data available',
              style: TextStyle(
                color: Colors.grey[400],
                fontSize: 16,
              ),
            ),
          ],
        ),
      );
    }

    return Container(
      padding: EdgeInsets.all(20),
      decoration: BoxDecoration(
        color: ThemeProvider.getCardColor(),
        borderRadius: BorderRadius.circular(16),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            children: [
              Icon(Icons.category, color: Colors.green, size: 24),
              SizedBox(width: 12),
              Text(
                'Income by Category',
                style: TextStyle(
                  color: ThemeProvider.getTextColor(),
                  fontSize: 20,
                  fontWeight: FontWeight.bold,
                ),
              ),
            ],
          ),
          SizedBox(height: 20),
          SizedBox(
            height: 200,
            child: PieChart(
              PieChartData(
                sections: incomeByCategory.entries.map((entry) {
                  final category = CategoryManager.getCategoryById(entry.key) ??
                      Category(id: '', name: 'Other', icon: Icons.category, color: Colors.grey, type: 'income');
                  final total = incomeByCategory.values.fold(0.0, (sum, amount) => sum + amount.toDouble());
                  final percentage = total > 0 ? (entry.value.toDouble() / total) * 100 : 0.0;

                  return PieChartSectionData(
                    value: entry.value.toDouble(),
                    color: category.color,
                    title: '${percentage.toStringAsFixed(1)}%',
                    radius: 60,
                    titleStyle: TextStyle(
                      color: Colors.white,
                      fontWeight: FontWeight.bold,
                      fontSize: 12,
                    ),
                  );
                }).toList(),
                sectionsSpace: 2,
                centerSpaceRadius: 40,
                pieTouchData: PieTouchData(enabled: true),
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildExpenseCategoriesChart() {
    final expenseByCategory = _getExpenseByCategory();

    if (expenseByCategory.isEmpty) {
      return Container(
        padding: EdgeInsets.all(20),
        decoration: BoxDecoration(
          color: ThemeProvider.getCardColor(),
          borderRadius: BorderRadius.circular(16),
        ),
        child: Column(
          children: [
            Icon(Icons.category_outlined, size: 64, color: Colors.grey[400]),
            SizedBox(height: 16),
            Text(
              'No expense data available',
              style: TextStyle(
                color: Colors.grey[400],
                fontSize: 16,
              ),
            ),
          ],
        ),
      );
    }

    return Container(
      padding: EdgeInsets.all(20),
      decoration: BoxDecoration(
        color: ThemeProvider.getCardColor(),
        borderRadius: BorderRadius.circular(16),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            children: [
              Icon(Icons.category, color: Colors.red, size: 24),
              SizedBox(width: 12),
              Text(
                'Expenses by Category',
                style: TextStyle(
                  color: ThemeProvider.getTextColor(),
                  fontSize: 20,
                  fontWeight: FontWeight.bold,
                ),
              ),
            ],
          ),
          SizedBox(height: 20),
          SizedBox(
            height: 200,
            child: PieChart(
              PieChartData(
                sections: expenseByCategory.entries.map((entry) {
                  final category = CategoryManager.getCategoryById(entry.key) ??
                      Category(id: '', name: 'Other', icon: Icons.category, color: Colors.grey, type: 'expense');
                  final total = expenseByCategory.values.fold(0.0, (sum, amount) => sum + amount.toDouble());
                  final percentage = total > 0 ? (entry.value.toDouble() / total) * 100 : 0.0;

                  return PieChartSectionData(
                    value: entry.value.toDouble(),
                    color: category.color,
                    title: '${percentage.toStringAsFixed(1)}%',
                    radius: 60,
                    titleStyle: TextStyle(
                      color: Colors.white,
                      fontWeight: FontWeight.bold,
                      fontSize: 12,
                    ),
                  );
                }).toList(),
                sectionsSpace: 2,
                centerSpaceRadius: 40,
                pieTouchData: PieTouchData(enabled: true),
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildIncomeCategoriesList() {
    final incomeByCategory = _getIncomeByCategory();
    final totalIncome = incomeByCategory.values.fold(0.0, (sum, amount) => sum + amount.toDouble());

    if (incomeByCategory.isEmpty) {
      return Container(
        padding: EdgeInsets.all(20),
        decoration: BoxDecoration(
          color: ThemeProvider.getCardColor(),
          borderRadius: BorderRadius.circular(16),
        ),
        child: Center(
          child: Text(
            'No income categories to display',
            style: TextStyle(
              color: Colors.grey[400],
              fontSize: 16,
            ),
          ),
        ),
      );
    }

    return Container(
      padding: EdgeInsets.all(20),
      decoration: BoxDecoration(
        color: ThemeProvider.getCardColor(),
        borderRadius: BorderRadius.circular(16),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(
            'Income Breakdown',
            style: TextStyle(
              color: ThemeProvider.getTextColor(),
              fontSize: 18,
              fontWeight: FontWeight.bold,
            ),
          ),
          SizedBox(height: 16),
          ...incomeByCategory.entries.map((entry) {
            final category = CategoryManager.getCategoryById(entry.key) ??
                Category(id: '', name: 'Other', icon: Icons.category, color: Colors.grey, type: 'income');
            final percentage = totalIncome > 0 ? (entry.value.toDouble() / totalIncome) * 100 : 0.0;

            return _buildCategoryListItem(category, entry.value.toDouble(), percentage);
          }),
        ],
      ),
    );
  }

  Widget _buildExpenseCategoriesList() {
    final expenseByCategory = _getExpenseByCategory();
    final totalExpense = expenseByCategory.values.fold(0.0, (sum, amount) => sum + amount.toDouble());

    if (expenseByCategory.isEmpty) {
      return Container(
        padding: EdgeInsets.all(20),
        decoration: BoxDecoration(
          color: ThemeProvider.getCardColor(),
          borderRadius: BorderRadius.circular(16),
        ),
        child: Center(
          child: Text(
            'No expense categories to display',
            style: TextStyle(
              color: Colors.grey[400],
              fontSize: 16,
            ),
          ),
        ),
      );
    }

    return Container(
      padding: EdgeInsets.all(20),
      decoration: BoxDecoration(
        color: ThemeProvider.getCardColor(),
        borderRadius: BorderRadius.circular(16),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(
            'Expense Breakdown',
            style: TextStyle(
              color: ThemeProvider.getTextColor(),
              fontSize: 18,
              fontWeight: FontWeight.bold,
            ),
          ),
          SizedBox(height: 16),
          ...expenseByCategory.entries.map((entry) {
            final category = CategoryManager.getCategoryById(entry.key) ??
                Category(id: '', name: 'Other', icon: Icons.category, color: Colors.grey, type: 'expense');
            final percentage = totalExpense > 0 ? (entry.value.toDouble() / totalExpense) * 100 : 0.0;

            return _buildCategoryListItem(category, entry.value.toDouble(), percentage);
          }),
        ],
      ),
    );
  }

  Widget _buildCategoryListItem(Category category, double amount, double percentage) {
    return Container(
      margin: EdgeInsets.only(bottom: 12),
      padding: EdgeInsets.all(16),
      decoration: BoxDecoration(
        color: category.color.withOpacity(0.1),
        borderRadius: BorderRadius.circular(12),
        border: Border.all(color: category.color.withOpacity(0.3)),
      ),
      child: Row(
        children: [
          Container(
            padding: EdgeInsets.all(8),
            decoration: BoxDecoration(
              color: category.color.withOpacity(0.2),
              borderRadius: BorderRadius.circular(8),
            ),
            child: Icon(category.icon, color: category.color, size: 20),
          ),
          SizedBox(width: 16),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Text(
                  category.name,
                  style: TextStyle(
                    color: ThemeProvider.getTextColor(),
                    fontSize: 16,
                    fontWeight: FontWeight.w600,
                  ),
                ),
                SizedBox(height: 4),
                Container(
                  height: 4,
                  decoration: BoxDecoration(
                    color: Colors.grey.withOpacity(0.3),
                    borderRadius: BorderRadius.circular(2),
                  ),
                  child: FractionallySizedBox(
                    alignment: Alignment.centerLeft,
                    widthFactor: (percentage / 100).clamp(0.0, 1.0),
                    child: Container(
                      decoration: BoxDecoration(
                        color: category.color,
                        borderRadius: BorderRadius.circular(2),
                      ),
                    ),
                  ),
                ),
              ],
            ),
          ),
          SizedBox(width: 16),
          Column(
            crossAxisAlignment: CrossAxisAlignment.end,
            children: [
              Text(
                '\$${amount.toStringAsFixed(2)}',
                style: TextStyle(
                  color: ThemeProvider.getTextColor(),
                  fontSize: 16,
                  fontWeight: FontWeight.bold,
                ),
              ),
              Text(
                '${percentage.toStringAsFixed(1)}%',
                style: TextStyle(
                  color: Colors.grey[400],
                  fontSize: 12,
                ),
              ),
            ],
          ),
        ],
      ),
    );
  }

  // FIXED: Recent Transactions Summary - Now Working Properly
  Widget _buildRecentTransactionsSummary() {
    final recentTransactions = _getFilteredTransactions()
        .take(5)
        .toList()
      ..sort((a, b) => b.date.compareTo(a.date)); // Sort by most recent first

    if (recentTransactions.isEmpty) {
      return Container(
        padding: EdgeInsets.all(20),
        decoration: BoxDecoration(
          color: ThemeProvider.getCardColor(),
          borderRadius: BorderRadius.circular(16),
        ),
        child: Column(
          children: [
            Icon(Icons.receipt_long_outlined, size: 64, color: Colors.grey[400]),
            SizedBox(height: 16),
            Text(
              'No recent transactions',
              style: TextStyle(
                color: Colors.grey[400],
                fontSize: 16,
              ),
            ),
            SizedBox(height: 12),
            Text(
              'Add some transactions to see them here',
              style: TextStyle(
                color: Colors.grey[500],
                fontSize: 14,
              ),
              textAlign: TextAlign.center,
            ),
          ],
        ),
      );
    }

    return Container(
      padding: EdgeInsets.all(10),
      decoration: BoxDecoration(
        color: ThemeProvider.getCardColor(),
        borderRadius: BorderRadius.circular(16),
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              Row(
                children: [
                  Icon(Icons.receipt_long, color: ThemeProvider.getPrimaryColor(), size: 24),
                  SizedBox(width: 12),
                  Text(
                    'Recent Transactions',
                    style: TextStyle(
                      color: ThemeProvider.getTextColor(),
                      fontSize: 18,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                ],
              ),
              TextButton.icon(
                onPressed: () => _showAllTransactions(),
                label: Text('View All'),
                style: TextButton.styleFrom(
                  foregroundColor: ThemeProvider.getPrimaryColor(),
                ),
              ),
            ],
          ),
          SizedBox(height: 16),

          // Transaction count indicator
          Container(
            padding: EdgeInsets.symmetric(horizontal: 12, vertical: 6),
            decoration: BoxDecoration(
              color: ThemeProvider.getPrimaryColor().withOpacity(0.1),
              borderRadius: BorderRadius.circular(20),
            ),
            child: Text(
              'Showing ${recentTransactions.length} of ${widget.transactions.length} transactions',
              style: TextStyle(
                color: ThemeProvider.getPrimaryColor(),
                fontSize: 12,
                fontWeight: FontWeight.w500,
              ),
            ),
          ),
          SizedBox(height: 16),

          // Transactions list
          ...recentTransactions.asMap().entries.map((entry) {
            final index = entry.key;
            final transaction = entry.value;
            return _buildEnhancedTransactionItem(transaction, index == recentTransactions.length - 1);
          }),

          // Show more button if there are more transactions
          if (widget.transactions.length > 5)
            Container(
              margin: EdgeInsets.only(top: 12),
              width: double.infinity,
              child: OutlinedButton.icon(
                onPressed: () => _showAllTransactions(),
                icon: Icon(Icons.add, size: 18),
                label: Text('Show ${widget.transactions.length - 5} More Transactions'),
                style: OutlinedButton.styleFrom(
                  foregroundColor: ThemeProvider.getPrimaryColor(),
                  side: BorderSide(color: ThemeProvider.getPrimaryColor().withOpacity(0.3)),
                  padding: EdgeInsets.symmetric(vertical: 12),
                  shape: RoundedRectangleBorder(
                    borderRadius: BorderRadius.circular(12),
                  ),
                ),
              ),
            ),
        ],
      ),
    );
  }

  Widget _buildEnhancedTransactionItem(Transaction transaction, bool isLast) {
    final isIncome = _isIncomeTransaction(transaction);
    final category = CategoryManager.getCategoryById(transaction.categoryId) ??
        Category(id: '', name: 'Other', icon: Icons.category, color: Colors.grey, type: isIncome ? 'income' : 'expense');

    // Format date
    final now = DateTime.now();
    final transactionDate = transaction.date;
    final difference = now.difference(transactionDate);

    String dateText;
    if (difference.inDays == 0) {
      if (difference.inHours == 0) {
        dateText = '${difference.inMinutes}m ago';
      } else {
        dateText = '${difference.inHours}h ago';
      }
    } else if (difference.inDays == 1) {
      dateText = 'Yesterday';
    } else if (difference.inDays < 7) {
      dateText = '${difference.inDays} days ago';
    } else {
      dateText = '${transactionDate.month}/${transactionDate.day}';
    }

    return GestureDetector(
      onTap: () => _showTransactionDetails(transaction),
      child: Container(
        margin: EdgeInsets.only(bottom: isLast ? 0 : 12),
        padding: EdgeInsets.all(16),
        decoration: BoxDecoration(
          color: category.color.withOpacity(0.05),
          borderRadius: BorderRadius.circular(12),
          border: Border.all(
            color: category.color.withOpacity(0.1),
            width: 1,
          ),
        ),
        child: Row(
          children: [
            // Category icon
            Container(
              padding: EdgeInsets.all(10),
              decoration: BoxDecoration(
                color: category.color.withOpacity(0.15),
                borderRadius: BorderRadius.circular(10),
              ),
              child: Icon(category.icon, color: category.color, size: 20),
            ),
            SizedBox(width: 16),

            // Transaction details
            Expanded(
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  Text(
                    transaction.title,
                    style: TextStyle(
                      color: ThemeProvider.getTextColor(),
                      fontSize: 16,
                      fontWeight: FontWeight.w600,
                    ),
                    maxLines: 1,
                    overflow: TextOverflow.ellipsis,
                  ),
                  SizedBox(height: 4),
                  Row(
                    children: [
                      Text(
                        category.name,
                        style: TextStyle(
                          color: Colors.grey[400],
                          fontSize: 12,
                        ),
                      ),
                      Text(
                        ' â€¢ ',
                        style: TextStyle(
                          color: Colors.grey[400],
                          fontSize: 12,
                        ),
                      ),
                      Text(
                        dateText,
                        style: TextStyle(
                          color: Colors.grey[400],
                          fontSize: category.name.length >= 9 ? 10 : 13,
                        ),
                      ),
                    ],
                  ),
                ],
              ),
            ),

            // Amount and type indicator
            Column(
              crossAxisAlignment: CrossAxisAlignment.end,
              children: [
                Text(
                  '${isIncome ? '+' : '-'}\$${transaction.amount.toStringAsFixed(2)}',
                  style: TextStyle(
                    color: isIncome ? Colors.green : Colors.red,
                    fontSize: transaction.amount.toStringAsFixed(2).length >= 9 ? 15 : 16,
                    fontWeight: FontWeight.bold,
                  ),
                ),
                SizedBox(height: 2),
                Container(
                  padding: EdgeInsets.symmetric(horizontal: 8, vertical: 2),
                  decoration: BoxDecoration(
                    color: isIncome ? Colors.green.withOpacity(0.1) : Colors.red.withOpacity(0.1),
                    borderRadius: BorderRadius.circular(10),
                  ),
                  child: Text(
                    isIncome ? 'Income' : 'Expense',
                    style: TextStyle(
                      color: isIncome ? Colors.green : Colors.red,
                      fontSize: 10,
                      fontWeight: FontWeight.w500,
                    ),
                  ),
                ),
              ],
            ),
          ],
        ),
      ),
    );
  }

  // Show all transactions in a modal bottom sheet
  void _showAllTransactions() {
    showModalBottomSheet(
      context: context,
      isScrollControlled: true,
      backgroundColor: Colors.transparent,
      builder: (context) => DraggableScrollableSheet(
        initialChildSize: 0.9,
        minChildSize: 0.5,
        maxChildSize: 0.95,
        builder: (context, scrollController) => Container(
          decoration: BoxDecoration(
            color: ThemeProvider.getBackgroundColor(),
            borderRadius: BorderRadius.vertical(top: Radius.circular(20)),
          ),
          child: Column(
            children: [
              // Handle bar
              Container(
                margin: EdgeInsets.only(top: 12, bottom: 20),
                width: 40,
                height: 4,
                decoration: BoxDecoration(
                  color: Colors.grey[400],
                  borderRadius: BorderRadius.circular(2),
                ),
              ),

              // Header
              Padding(
                padding: EdgeInsets.symmetric(horizontal: 20),
                child: Row(
                  mainAxisAlignment: MainAxisAlignment.spaceBetween,
                  children: [
                    Text(
                      'All Transactions',
                      style: TextStyle(
                        color: ThemeProvider.getTextColor(),
                        fontSize: 24,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                    IconButton(
                      onPressed: () => Navigator.pop(context),
                      icon: Icon(Icons.close, color: ThemeProvider.getTextColor()),
                    ),
                  ],
                ),
              ),

              // Transactions list
              Expanded(
                child: _buildAllTransactionsList(scrollController),
              ),
            ],
          ),
        ),
      ),
    );
  }

  // Build complete transactions list
  Widget _buildAllTransactionsList(ScrollController scrollController) {
    final allTransactions = _getFilteredTransactions()
      ..sort((a, b) => b.date.compareTo(a.date));

    if (allTransactions.isEmpty) {
      return Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            Icon(Icons.receipt_long_outlined, size: 80, color: Colors.grey[400]),
            SizedBox(height: 16),
            Text(
              'No transactions found',
              style: TextStyle(
                color: Colors.grey[400],
                fontSize: 18,
                fontWeight: FontWeight.w500,
              ),
            ),
            SizedBox(height: 8),
            Text(
              'Try changing the time period or add some transactions',
              style: TextStyle(
                color: Colors.grey[500],
                fontSize: 14,
              ),
              textAlign: TextAlign.center,
            ),
          ],
        ),
      );
    }

    return ListView.builder(
      controller: scrollController,
      padding: EdgeInsets.symmetric(horizontal: 20),
      itemCount: allTransactions.length,
      itemBuilder: (context, index) {
        final transaction = allTransactions[index];
        return Dismissible(
          key: Key(transaction.id),
          direction: DismissDirection.endToStart,
          background: Container(
            alignment: Alignment.centerRight,
            padding: EdgeInsets.symmetric(horizontal: 20),
            decoration: BoxDecoration(
              color: Colors.red,
              borderRadius: BorderRadius.circular(12),
            ),
            child: Icon(Icons.delete, color: Colors.white),
          ),
          confirmDismiss: (direction) async {
            return await showDialog(
              context: context,
              builder: (context) => AlertDialog(
                backgroundColor: ThemeProvider.getBackgroundColor(),
                title: Text('Delete Transaction'),
                content: Text('Are you sure you want to delete this transaction?'),
                actions: [
                  TextButton(
                    onPressed: () => Navigator.of(context).pop(false),
                    child: Text('Cancel'),
                  ),
                  ElevatedButton(
                    onPressed: () => Navigator.of(context).pop(true),
                    style: ElevatedButton.styleFrom(backgroundColor: Colors.red),
                    child: Text('Delete', style: TextStyle(color: Colors.white)),
                  ),
                ],
              ),
            );
          },
          onDismissed: (direction) {
            setState(() {
              widget.transactions.removeWhere((t) => t.id == transaction.id);
              // shared_preferences yangilansin
              saveTransactions(widget.transactions);
            });

            ScaffoldMessenger.of(context).showSnackBar(
              SnackBar(
                content: Text('Transaction deleted'),
                backgroundColor: Colors.red,
              ),
            );
          },
          child: _buildEnhancedTransactionItem(transaction, index == allTransactions.length - 1),
        );
      },
    );
  }


  // Show transaction details
  void _showTransactionDetails(Transaction transaction) {
    final isIncome = _isIncomeTransaction(transaction);
    final category = CategoryManager.getCategoryById(transaction.categoryId) ??
        Category(id: '', name: 'Other', icon: Icons.category, color: Colors.grey, type: isIncome ? 'income' : 'expense');

    showDialog(
      context: context,
      builder: (context) => Dialog(
        backgroundColor: ThemeProvider.getCardColor(),
        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20)),
        child: Container(
          padding: EdgeInsets.all(24),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              // Header
              Row(
                children: [
                  Container(
                    padding: EdgeInsets.all(12),
                    decoration: BoxDecoration(
                      color: category.color.withOpacity(0.15),
                      borderRadius: BorderRadius.circular(12),
                    ),
                    child: Icon(category.icon, color: category.color, size: 28),
                  ),
                  SizedBox(width: 16),
                  Expanded(
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text(
                          'Transaction Details',
                          style: TextStyle(
                            color: ThemeProvider.getTextColor(),
                            fontSize: 20,
                            fontWeight: FontWeight.bold,
                          ),
                        ),
                        Text(
                          isIncome ? 'Income Transaction' : 'Expense Transaction',
                          style: TextStyle(
                            color: isIncome ? Colors.green : Colors.red,
                            fontSize: 14,
                            fontWeight: FontWeight.w500,
                          ),
                        ),
                      ],
                    ),
                  ),
                ],
              ),
              SizedBox(height: 24),

              // Transaction info
              _buildDetailRow('Title', transaction.title),
              _buildDetailRow('Category', category.name),
              _buildDetailRow('Amount', '\$${transaction.amount.toStringAsFixed(2)}'),
              _buildDetailRow('Type', isIncome ? 'Income' : 'Expense'),
              _buildDetailRow('Date', '${transaction.date.month}/${transaction.date.day}/${transaction.date.year}'),
              _buildDetailRow('Time', '${transaction.date.hour.toString().padLeft(2, '0')}:${transaction.date.minute.toString().padLeft(2, '0')}'),

              SizedBox(height: 24),

              // Close button
              SizedBox(
                width: double.infinity,
                child: ElevatedButton(
                  onPressed: () => Navigator.pop(context),
                  style: ElevatedButton.styleFrom(
                    backgroundColor: ThemeProvider.getPrimaryColor(),
                    padding: EdgeInsets.symmetric(vertical: 16),
                    shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(12),
                    ),
                  ),
                  child: Text(
                    'Close',
                    style: TextStyle(
                      color: Colors.white,
                      fontSize: 16,
                      fontWeight: FontWeight.w600,
                    ),
                  ),
                ),
              ),
            ],
          ),
        ),
      ),
    );
  }

  // Helper method for detail rows
  Widget _buildDetailRow(String label, String value) {
    return Container(
      margin: EdgeInsets.only(bottom: 16),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          SizedBox(
            width: 80,
            child: Text(
              label,
              style: TextStyle(
                color: Colors.grey[400],
                fontSize: 14,
                fontWeight: FontWeight.w500,
              ),
            ),
          ),
          Expanded(
            child: Text(
              value,
              style: TextStyle(
                color: ThemeProvider.getTextColor(),
                fontSize: 14,
                fontWeight: FontWeight.w600,
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildLegendItem(String label, Color color, double amount) {
    return Row(
      children: [
        Container(
          width: 16,
          height: 16,
          decoration: BoxDecoration(
            color: color,
            borderRadius: BorderRadius.circular(4),
          ),
        ),
        SizedBox(width: 8),
        Column(
          crossAxisAlignment: CrossAxisAlignment.start,
          children: [
            Text(
              label,
              style: TextStyle(
                color: ThemeProvider.getTextColor(),
                fontSize: 14,
                fontWeight: FontWeight.w500,
              ),
            ),
            Text(
              '\$${amount.toStringAsFixed(2)}',
              style: TextStyle(
                color: Colors.grey[400],
                fontSize: 12,
              ),
            ),
          ],
        ),
      ],
    );
  }

  // Helper methods
  List<Transaction> _getFilteredTransactions() {
    final now = DateTime.now();
    DateTime startDate;

    switch (_selectedPeriod) {
      case 'This Week':
        startDate = now.subtract(Duration(days: now.weekday - 1));
        break;
      case 'This Month':
        startDate = DateTime(now.year, now.month, 1);
        break;
      case 'Last 3 Months':
        startDate = DateTime(now.year, now.month - 3, 1);
        break;
      case 'This Year':
        startDate = DateTime(now.year, 1, 1);
        break;
      default:
        return widget.transactions;
    }

    return widget.transactions.where((transaction) {
      return transaction.date.isAfter(startDate) || transaction.date.isAtSameMomentAs(startDate);
    }).toList();
  }

  double _calculateTotalIncome(List<Transaction> transactions) {
    return transactions
        .where((t) => _isIncomeTransaction(t))
        .fold(0.0, (sum, t) => sum + t.amount.toDouble());
  }

  double _calculateTotalExpense(List<Transaction> transactions) {
    return transactions
        .where((t) => !_isIncomeTransaction(t))
        .fold(0.0, (sum, t) => sum + t.amount.toDouble());
  }

  Map<String, double> _getIncomeByCategory() {
    final filteredTransactions = _getFilteredTransactions();
    final incomeTransactions = filteredTransactions.where((t) => _isIncomeTransaction(t));

    Map<String, double> incomeByCategory = {};
    for (var transaction in incomeTransactions) {
      incomeByCategory[transaction.categoryId] =
          (incomeByCategory[transaction.categoryId] ?? 0.0) + transaction.amount.toDouble();
    }
    return incomeByCategory;
  }

  Map<String, double> _getExpenseByCategory() {
    final filteredTransactions = _getFilteredTransactions();
    final expenseTransactions = filteredTransactions.where((t) => !_isIncomeTransaction(t));

    Map<String, double> expenseByCategory = {};
    for (var transaction in expenseTransactions) {
      expenseByCategory[transaction.categoryId] =
          (expenseByCategory[transaction.categoryId] ?? 0.0) + transaction.amount.toDouble();
    }
    return expenseByCategory;
  }

  // Generate real balance trend data from actual transactions
  List<FlSpot> _generateRealBalanceTrendData() {
    final filteredTransactions = _getFilteredTransactions();

    if (filteredTransactions.isEmpty) {
      return [];
    }

    // Sort transactions by date
    filteredTransactions.sort((a, b) => a.date.compareTo(b.date));

    // Group transactions by date
    Map<DateTime, double> dailyBalanceChanges = {};

    for (var transaction in filteredTransactions) {
      final dateKey = DateTime(transaction.date.year, transaction.date.month, transaction.date.day);
      final amount = _isIncomeTransaction(transaction) ? transaction.amount.toDouble() : -transaction.amount.toDouble();
      dailyBalanceChanges[dateKey] = (dailyBalanceChanges[dateKey] ?? 0.0) + amount;
    }

    // Convert to cumulative balance over time
    List<FlSpot> spots = [];
    double cumulativeBalance = 0.0;
    int index = 0;

    final sortedDates = dailyBalanceChanges.keys.toList()..sort();

    for (var date in sortedDates) {
      cumulativeBalance += dailyBalanceChanges[date]!;
      spots.add(FlSpot(index.toDouble(), cumulativeBalance));
      index++;
    }

    return spots;
  }

  // Helper method to get date for chart index
  DateTime _getDateForIndex(int index) {
    final filteredTransactions = _getFilteredTransactions();

    if (filteredTransactions.isEmpty) {
      return DateTime.now();
    }

    filteredTransactions.sort((a, b) => a.date.compareTo(b.date));

    // Group by date and get unique dates
    Set<DateTime> uniqueDates = {};
    for (var transaction in filteredTransactions) {
      uniqueDates.add(DateTime(transaction.date.year, transaction.date.month, transaction.date.day));
    }

    final sortedDates = uniqueDates.toList()..sort();

    if (index >= 0 && index < sortedDates.length) {
      return sortedDates[index];
    }

    return DateTime.now();
  }
}
